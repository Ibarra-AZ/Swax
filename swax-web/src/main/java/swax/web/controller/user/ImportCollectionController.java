package swax.web.controller.user;
import java.io.IOException;import java.text.ParseException;import java.util.List;import javax.servlet.http.HttpServletRequest;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Controller;import org.springframework.web.bind.annotation.ModelAttribute;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.multipart.MultipartFile;import org.springframework.web.servlet.ModelAndView;import swax.web.form.PojoModelImportCollectionForm;import swax.webservice.dto.AlbumDTO;import swax.webservice.entity.AlbumDiscogs;import swax.webservice.entity.User;import swax.webservice.service.IAlbumCollectedService;import swax.webservice.service.IAlbumDiscogsService;import swax.webservice.service.IAlbumService;import swax.webservice.service.IUserService;
@Controllerpublic class ImportCollectionController {
	@Autowired	private IUserService userService = null;		@Autowired	private IAlbumCollectedService albumCollectedService = null;		@Autowired	private IAlbumService albumService = null;		@Autowired	IAlbumDiscogsService albumDiscogsService = null;		@RequestMapping(value="/importDiscogsCollection")	public ModelAndView importDiscogsCollection(@ModelAttribute(value="importCollectionModelAttribute") 			final PojoModelImportCollectionForm importCollectionForm, HttpServletRequest request, 			final ModelAndView mav) throws IOException, ParseException {				boolean hasCollection = true;		boolean hasWantlist = true;		User user = (User) request.getSession().getAttribute("user");						/** START Import with UPLOAD **/				MultipartFile file = importCollectionForm.getDiscogsFilePath();		List<AlbumDiscogs> albumsDiscogs = userService.getDiscogsCollectionUpload(file, request);				/** END Import with UPLOAD **/				albumsDiscogs = albumDiscogsService.trimAlbumsDiscogs(albumsDiscogs);		albumService.updateAlbumTable(albumsDiscogs);		albumCollectedService.createUserCollection(user, albumsDiscogs);		//		TODO Do init() method for User (get collection & wantlist)				List<AlbumDTO> albumsWantlistDTO = user.getAlbumsWantlistDTO();				System.out.println("ALBUMS = "+albumsWantlistDTO.size());				if (albumsWantlistDTO.size()==0) {			hasWantlist = false;		}				List<AlbumDTO> albumsDTO = user.getAlbumsDTO();				System.out.println("ALBUMS = "+albumsDTO.size());				if (albumsDTO.size()==0) {			hasCollection = false;		}				request.getSession().setAttribute("hasCollection", hasCollection);		mav.getModel().put("userCollection", albumsDTO);		request.getSession().setAttribute("hasWantlist", hasWantlist);		mav.getModel().put("userWantlist", albumsWantlistDTO);		mav.setViewName("mySwax");				return mav;	}
}