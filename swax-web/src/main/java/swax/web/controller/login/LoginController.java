package swax.web.controller.login;
import java.util.Date;import org.apache.log4j.Logger;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Controller;import org.springframework.web.bind.annotation.ModelAttribute;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RequestMethod;import org.springframework.web.servlet.ModelAndView;import swax.web.component.sessionscope.HasCollection;import swax.web.component.sessionscope.HasWantlist;import swax.web.component.sessionscope.SessionUser;import swax.web.form.PojoModelLoginForm;import swax.web.mav.utils.MavUtil;import swax.webservice.entity.user.User;import swax.webservice.entity.user.UserStatusEnum;import swax.webservice.service.user.IUserService;import swax.webservice.tools.DateUtils;
@Controllerpublic class LoginController {
	@Autowired	private IUserService userService = null;		@Autowired	private MavUtil mavUtil = null;		@Autowired	private HasCollection hasCollectionSession;		@Autowired	private HasWantlist hasWantlistSession;		@Autowired	private SessionUser sessionUser;		private Logger logger = Logger.getLogger(this.getClass());		@RequestMapping(value="/")	public ModelAndView loadSwax(ModelAndView mav) {				logger.info(this.getClass().getName()+": loadSwax");				mavUtil.initStartCounts(mav);		mav.setViewName("login/start");				return mav;	}		@RequestMapping(value="/signin")	public ModelAndView signIn(ModelAndView mav, PojoModelLoginForm loginForm) {				logger.debug(this.getClass().getName()+": signIn");				String errorMsg="";		loginForm.setErrorMsg(errorMsg);		mav.getModel().put("loginModelAttribute", loginForm);		mav.setViewName("login/login");		return mav;	}
	@RequestMapping(value="/loginAction")	public ModelAndView login(@ModelAttribute(value="loginModelAttribute" ) PojoModelLoginForm loginForm, ModelAndView mav) {				logger.debug(this.getClass().getName()+": login");				User user;		String errorMsg="";		String infoMsg="";		boolean hasCollection = hasCollectionSession.isHasCollection();		boolean hasWantlist = hasWantlistSession.isHasWantlist();				try {			user = this.userService.findByEmailAndPassword(loginForm.getEmail(), loginForm.getPassword());		} catch (Exception e) {//			TODO Créer et gérer les exceptions			user = null;			System.out.println(e.toString());		}				// USER EXISTS		if (user != null){			user.setLastConnexion(DateUtils.dateToString(new Date()));			userService.createUpdateEntity(user);						// BANNED USER			if (user.getStatus().equals(UserStatusEnum.Banned.getUserStatus())) {				errorMsg = "There's a problem. This user has been banned from Swax. Please contact Swax administration"						+ " if there's no reason for this situation.";				loginForm.setErrorMsg(errorMsg);				sessionUser.setSessionUser(null);				mav.getModel().put("loginModelAttribute", loginForm);				mav.setViewName("login/login");			} 						// AUTHORIZED USER			else {				sessionUser.setSessionUser(user);				mav = mavUtil.mySwax(user);				return mav;			}				// USER DOESN'T EXIST		} else {			errorMsg="Please enter a valid identification";			loginForm.setErrorMsg(errorMsg);			sessionUser.setSessionUser(null);			mav.getModel().put("loginModelAttribute", loginForm);			mav.setViewName("login/login");		}				mav.getModel().put("infoMsg", infoMsg);		mav.getModel().put("hasCollection", hasCollection);		mav.getModel().put("hasWantlist", hasWantlist);				return mav;	}		@RequestMapping(value="/login")	public ModelAndView loadLoginPage(ModelAndView mav, PojoModelLoginForm loginForm) {				logger.debug(this.getClass().getName()+": loadLoginPage");				String errorMsg="";		loginForm.setErrorMsg(errorMsg);		mav.getModel().put("loginModelAttribute", loginForm);		mav.setViewName("login/login");		return mav;	}		@RequestMapping(value="/logout", method = RequestMethod.GET)	public ModelAndView logout(ModelAndView mav) {				logger.debug(this.getClass().getName()+": logout");				sessionUser.setSessionUser(null);				mav.getModel().put("errorMsg", "");		mavUtil.initStartCounts(mav);		mav.setViewName("login/start");				return mav;	}		}