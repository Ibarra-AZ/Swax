package swax.web.controller;
import java.io.IOException;import java.util.List;import javax.servlet.http.HttpServletRequest;import javax.validation.Valid;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Controller;import org.springframework.ui.ModelMap;import org.springframework.validation.BindingResult;import org.springframework.web.bind.annotation.ModelAttribute;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RequestMethod;import org.springframework.web.multipart.MultipartFile;import org.springframework.web.servlet.ModelAndView;import swax.web.form.PojoModelImportCollectionForm;import swax.web.form.PojoModelRegisterForm;import swax.webservice.dto.AlbumDTO;import swax.webservice.entity.AlbumDiscogs;import swax.webservice.entity.User;import swax.webservice.service.IUserService;import swax.webservice.tools.FilesTools;
@Controllerpublic class UserProfileController {
	@Autowired	private IUserService userService = null;
	@RequestMapping(value="/loadUserProfilePage", method = RequestMethod.GET)	public ModelAndView changeUserProfile(@Valid @ModelAttribute(value="registerModelAttribute") 		final PojoModelRegisterForm registerForm, 		final BindingResult pBindingResult, HttpServletRequest request, final ModelMap pModel) {				ModelAndView mav = new ModelAndView();		User user = (User) request.getSession().getAttribute("user");				registerForm.setEmail(user.getEmail());		registerForm.setUserName(user.getUserName());		registerForm.setCountry(user.getCountry());				mav.getModel().put("registerModelAttribute", registerForm);		mav.setViewName("user/changeProfile");				return mav;	}		@RequestMapping(value="/changeProfileAction", method = RequestMethod.POST)	public ModelAndView changeProfileAction(@Valid @ModelAttribute(value="registerModelAttribute") 		final PojoModelRegisterForm registerForm, 		final BindingResult pBindingResult, HttpServletRequest request, final ModelAndView mav) {				String infoMsg="";		boolean hasCollection = false;		User user = (User) request.getSession().getAttribute("user");				user.setUserName(registerForm.getUserName());		user.setEmail(registerForm.getEmail());		user.setPassword(registerForm.getPassword());		user.setCountry(registerForm.getCountry());		user.setDiscogsName(registerForm.getDiscogsName());				userService.createUpdateEntity(user);				request.getSession().setAttribute("user", user);				List<AlbumDTO> albumsDTO = user.getAlbumsDTO();				if (albumsDTO.size() == 0) {			infoMsg = "It seems that you don't have any collection.";			mav.getModel().put("importCollectionModelAttribute", new PojoModelImportCollectionForm());		} else {			infoMsg = "You can now browse your collection and start to swap your wax ;-)";			hasCollection = true;			mav.getModel().put("userCollection", albumsDTO);		}		        mav.getModel().put("user", user);		mav.getModel().put("registerModelAttribute", registerForm);		mav.getModel().put("infoMsg", infoMsg);		mav.getModel().put("hasCollection", hasCollection);		mav.setViewName("mySwax");				return mav;	}		@RequestMapping(value="/backToMySwax")	public ModelAndView backToMySwax(HttpServletRequest request, final ModelAndView mav) {				String infoMsg="";		boolean hasCollection = false;				User user = (User) request.getSession().getAttribute("user");				List<AlbumDTO> albumsDTO = user.getAlbumsDTO();				if (albumsDTO.size() == 0) {			infoMsg = "It seems that you don't have any collection.";			mav.getModel().put("importCollectionModelAttribute", new PojoModelImportCollectionForm());		} else {			infoMsg = "You can now browse your collection and start to swap your wax ;-)";			hasCollection = true;			mav.getModel().put("userCollection", albumsDTO);		}        mav.getModel().put("user", user);		mav.getModel().put("infoMsg", infoMsg);		mav.getModel().put("hasCollection", hasCollection);		mav.setViewName("mySwax");				return mav;	}		@RequestMapping(value="/importDiscogsCollection")	public ModelAndView importDicogsCollection(@ModelAttribute(value="importCollectionModelAttribute") 			final PojoModelImportCollectionForm importCollectionForm, HttpServletRequest request, 			final ModelAndView mav) throws IOException {				boolean hasCollection = true;		User user = (User) request.getSession().getAttribute("user");		MultipartFile file = importCollectionForm.getDiscogsFilePath();		//		TODO Import Discogs Collection for User//		String discogsUrl = importCollectionForm.getDiscogsURL();		FilesTools.uploadFile(file, request);		String filePath = request.getServletContext().getRealPath("files/"+file.getOriginalFilename());		List<AlbumDiscogs> albumsDiscogs = FilesTools.importCSVFile(filePath);				List<AlbumDTO> albumsDTO = user.getAlbumsDTO();		if (albumsDTO.size()==0) {			hasCollection = false;		}		mav.getModel().put("userCollection", albumsDTO);		mav.getModel().put("hasCollection", hasCollection);		mav.setViewName("mySwax");		return mav;	}
}